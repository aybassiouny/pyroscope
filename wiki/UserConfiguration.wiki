#summary PyroScope configuration.
#labels configuration,installation,cli,Featured

<wiki:toc />

= Introduction =

After you installed the software as outlined on QuickStartGuide, you need to add personal configuration that is loaded from the directory `~/.pyroscope` containing the files `config.ini` and `config.py`. A default set can be automatically created for you, see below for details.

*âž½ IMPORTANT: For a fresh installation in addition to an existing rTorrent one, you will also need to follow the [MigrationGuide "migration" instructions], which fill in some data your already running rTorrent instance is missing otherwise.*

For simple setups, you only need to edit the plain text file `config.ini`. The script `config.py` allows much more detailed control over complex setups, at the price of you knowing at least the basics of the Python programming language.

If you have any problems with or questions about your configuration, subscribe to the [http://groups.google.com/group/pyroscope-users pyroscope-users] mailing list to get help from the community, or join the inofficial <a href="irc://irc.freenode.net/rtorrent">`#rtorrent`</a> channel on `irc.freenode.net`.


= Creating a set of default configuration files =

To create your own configuration, the best way is to start from the default files that are part of your PyroScope installation. To create them at the default location `~/.pyroscope`, simply call this command:
{{{
pyroadmin --create-config
}}}
Note that you can delete anything you don't want changed, since the defaults are _always_ loaded first. Deleting unchanged defaults has the advantage that on software updates, you'll automatically get the newer version of settings, if they're updated.

If you need several distinct configuration sets, just add the `--config-dir` option like so:
{{{
pyroadmin --create-config --config-dir ~/rtorrent/special/.pyroscope
}}}

To view your configuration, use this (again, use the `--config-dir` option for non-default configurations):
{{{
pyroadmin --dump-config
}}}


= Setting values in `config.ini` =

The configuration file consists of sections, led by a `[section]` header and followed by `name: value` entries; `name = value` is also accepted. Longer values can be broken into several lines and the continuation lines must be indented (start with a space). Note that leading whitespace is removed from values. 

Lines beginning with a semicolon (`;`), a hash mark (`#`), or the letters `REM` (uppercase or lowercase) will be ignored and can be used for comments. You cannot put a comment on an option line, a comment *MUST* start the beginning of a line!

As an example, this is a very minimal configuration file: 
{{{
# PyroScope configuration file

[GLOBAL]
# Note that the "config_dir" value is provided by the system!
config_script = %(config_dir)s/config.py
rtorrent_rc = ~/.rtorrent.rc

[ANNOUNCE]
# Add alias names for announce URLs to this section; those aliases are used
# at many places, e.g. by the "mktor" tool

# Public trackers
PBT     = http://tracker.publicbt.com:80/announce
          udp://tracker.publicbt.com:80/announce
OBT     = http://tracker.openbittorrent.com:80/announce
          udp://tracker.openbittorrent.com:80/announce
Debian  = http://bttracker.debian.org:6969/announce
}}}

_For advanced users:_ Values can contain format strings of the form `%(name)s` which refer to other values in the same section, or values in the `[DEFAULT]` section.

= Extending your `.rtorrent.rc` =

You need either a `scgi_local` or `scgi_port` specification in your rTorrent configuration; `scgi_local` is preferable since more secure. Furthermore, you need to provide the path to a `session` directory. See the [http://libtorrent.rakshasa.no/rtorrent/rtorrent.1.html rTorrent man page] for details.

For the `loaded` and `completed` fields to work (added in version 0.3.4), as well as the `started`, `leechtime` and `seedtime` ones, you also have to add this:
{{{
#
# PyroScope SETTINGS
#

# VIEW: Default view for filtering results
view_add = rtcontrol

# VIEW: Show active torrents (in view #9) and update every 20 seconds
schedule = filter_active,20,20,"view_filter = active,\"or={d.get_up_rate=,d.get_down_rate=}\""

# EVENTS: Timestamps
#   tm_loaded = time loaded into client
#   tm_started = time of *first* start
#   tm_completed = time of completion
system.method.insert = pyro.tm_started.now,simple|private,"d.set_custom=tm_started,$cat=$system.time= ;d.save_session="
system.method.set_key = event.download.resumed,time_stamp,"branch=d.get_custom=tm_started,false=,pyro.tm_started.now="
system.method.set_key = event.download.inserted_new,time_stamp,"d.set_custom=tm_loaded,$cat=$system.time= ;d.save_session="
system.method.set_key = event.download.finished,time_stamp,"d.set_custom=tm_completed,$cat=$system.time= ;d.save_session="

# EVENTS: Activation intervals
system.method.insert = pyro.activations.append,simple|private,"d.set_custom=activations,\"$cat=$d.get_custom=activations,$argument.0=,$system.time=\" ;d.save_session="
system.method.set_key = event.download.paused,activations,"pyro.activations.append=P"
system.method.set_key = event.download.resumed,activations,"pyro.activations.append=R"

# COMMAND: Return startup time (can be used to calculate uptime)
system.method.insert = startup_time,value,$system.time=

# COMMAND: Remove current item and its data
system.method.insert = cull,simple,"execute_nothrow=rtcontrol,-q,--detach,--cull,--yes,\"$cat=hash=,$d.get_hash=\""
}}}

*Note that if you just freshly installed PyroScope into an existing rTorrent installation, you must also follow the [MigrationGuide "migration" instructions] to add missing data to your already loaded downloads. Else, those items will NOT be filtered correctly.*

BTW, given these extensions, you can also sort your `main` view by completion time:
{{{
# Show recently completed top-most in "main"
view_sort_current = main,greater=d.get_custom=tm_completed
view_filter_on = main,event.download.finished
}}}


= Modifying and extending your configuration via `config.py` =

== Defining your own custom fields ==
To add user-defined fields in addition to the built-in ones, you can put code like this into your `~/.pyroscope/config.py` file (you need at least version 0.3.4 of `pyrocore`):
{{{
def _custom_fields():
    """ Yield custom field definitions.
    """
    import os
    from pyrocore.torrent import engine, matching
    from pyrocore.util import fmt

    def has_nfo(obj):
        "Check for .NFO file."
        pathname = obj.path
        if pathname and os.path.isdir(pathname):
            return any(i.lower().endswith(".nfo") for i in os.listdir(pathname))
        else:
            return False if pathname else None

    def has_thumb(obj):
        "Check for folder.jpg file."
        pathname = obj.path
        if pathname and os.path.isdir(pathname):
            return any(i.lower() == "folder.jpg" for i in os.listdir(pathname))
        else:
            return False if pathname else None

    def get_tracker_field(obj, name):
        "Get a field from tracker in focus."
        idx = obj.fetch("tracker_focus") % obj._fields["tracker_size"]
        return getattr(obj._engine._rpc.t, name)(obj._fields["hash"], idx)

    # Add file checkers
    yield engine.DynamicField(engine.untyped, "has_nfo", "does download have a .NFO file?", 
        matcher=matching.BoolFilter, accessor=has_nfo, 
        formatter=lambda val: "NFO" if val else "!DTA" if val is None else "----")
    yield engine.DynamicField(engine.untyped, "has_thumb", "does download have a folder.jpg file?", 
        matcher=matching.BoolFilter, accessor=has_thumb, 
        formatter=lambda val: "THMB" if val else "!DTA" if val is None else "----")

    # Add rTorrent attributes not available by default
    yield engine.OnDemandField(int, "peers_connected", "number of connected peers", matcher=matching.FloatFilter)
    yield engine.DynamicField(int, "seeds", "number of seeds", matcher=matching.FloatFilter,
        accessor=lambda o: get_tracker_field(o, "get_scrape_complete"))
    yield engine.DynamicField(int, "leeches", "number of leeches", matcher=matching.FloatFilter,
        accessor=lambda o: get_tracker_field(o, "get_scrape_incomplete"))
    yield engine.DynamicField(engine.untyped, "lastscraped", "time of last scrape", matcher=matching.TimeFilter,
        accessor=lambda o: get_tracker_field(o, "get_scrape_time_last"), 
        formatter=lambda dt: fmt.human_duration(float(dt), precision=2, short=True))

# Register our factory with the system
custom_field_factories.append(_custom_fields)
}}}

After you did that, you can use your custom field just like any built-in one, e.g. issue a command like `rtcontrol size=+4g -q -ohas_nfo,name`. They're also listed when you call `rtcontrol --help-fields`.